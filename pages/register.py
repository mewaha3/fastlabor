import streamlit as st
import gspread
import json
import pandas as pd
from oauth2client.service_account import ServiceAccountCredentials

# ‚úÖ ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Google Sheets API
scope = ["https://spreadsheets.google.com/feeds", "https://www.googleapis.com/auth/drive"]

try:
    # ‚úÖ ‡πÇ‡∏´‡∏•‡∏î Credentials ‡∏à‡∏≤‡∏Å Streamlit Secrets (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Cloud)
    if "gcp" in st.secrets:
        credentials_dict = json.loads(st.secrets["gcp"]["credentials"])
        creds = ServiceAccountCredentials.from_json_keyfile_dict(credentials_dict, scope)
    else:
        # ‚úÖ ‡πÇ‡∏´‡∏•‡∏î Credentials ‡∏à‡∏≤‡∏Å‡πÑ‡∏ü‡∏•‡πå (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Local)
        creds = ServiceAccountCredentials.from_json_keyfile_name("pages/credentials.json", scope)

    # ‚úÖ ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Google Sheets
    client = gspread.authorize(creds)
    sheet = client.open("fastlabor").sheet1  # ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡∏ä‡∏∑‡πà‡∏≠ Google Sheets ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì

except Exception as e:
    st.error(f"‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ö Google Sheets: {e}")
    st.stop()

# ‚úÖ ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î ‡∏≠‡∏≥‡πÄ‡∏†‡∏≠ ‡∏ï‡∏≥‡∏ö‡∏• ‡πÅ‡∏•‡∏∞‡∏£‡∏´‡∏±‡∏™‡πÑ‡∏õ‡∏£‡∏©‡∏ì‡∏µ‡∏¢‡πå
@st.cache_data
def load_location_data():
    url = "https://raw.githubusercontent.com/kongvut/thai-province-data/master/api_province.json"
    provinces = pd.read_json(url)

    url_amphur = "https://raw.githubusercontent.com/kongvut/thai-province-data/master/api_amphure.json"
    districts = pd.read_json(url_amphur)

    url_tambon = "https://raw.githubusercontent.com/kongvut/thai-province-data/master/api_tambon.json"
    subdistricts = pd.read_json(url_tambon)

    return provinces, districts, subdistricts

provinces, districts, subdistricts = load_location_data()

# ‚úÖ ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏´‡∏ô‡πâ‡∏≤ Streamlit
st.set_page_config(page_title="New Member Registration", page_icon="üìù", layout="centered")

st.image("image.png", width=150)  # ‡πÅ‡∏™‡∏î‡∏á‡πÇ‡∏•‡πÇ‡∏Å‡πâ
st.title("New Member")

# ‚úÖ ‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô
with st.form(key="register_form"):
    st.markdown("#### Personal Information")
    first_name = st.text_input("First name *", placeholder="Enter your first name")
    last_name = st.text_input("Last name *", placeholder="Enter your last name")
    
    # ‚úÖ National ID (‡∏£‡∏±‡∏ö‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç 13 ‡∏´‡∏•‡∏±‡∏Å)
    national_id = st.text_input("National ID *", placeholder="Enter your ID number")
    if national_id and (not national_id.isdigit() or len(national_id) != 13):
        st.error("‚ùå National ID ‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç 13 ‡∏´‡∏•‡∏±‡∏Å‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô")

    dob = st.date_input("Date of Birth *")
    gender = st.selectbox("Gender *", ["Male", "Female", "Other"])
    nationality = st.text_input("Nationality *", placeholder="Enter your nationality")

    st.markdown("#### Address Information")
    address = st.text_area("Address (House Number, Road, Soi.) *", placeholder="Enter your address")

    # ‚úÖ Province
    province_names = provinces["name_th"].tolist()
    province = st.selectbox("Province *", ["Select Province"] + province_names)

    # ‚úÖ District (‡∏Å‡∏£‡∏≠‡∏á‡∏ï‡∏≤‡∏°‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å)
    if province != "Select Province":
        province_id = provinces[provinces["name_th"] == province]["id"].values[0]
        district_names = districts[districts["province_id"] == province_id]["name_th"].tolist()
        district = st.selectbox("District *", ["Select District"] + district_names)
    else:
        district = st.selectbox("District *", ["Select District"])

    # ‚úÖ Subdistrict & Zip Code (‡∏Å‡∏£‡∏≠‡∏á‡∏ï‡∏≤‡∏°‡∏≠‡∏≥‡πÄ‡∏†‡∏≠‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å)
    if district != "Select District":
        district_id = districts[districts["name_th"] == district]["id"].values[0]
        subdistrict_data = subdistricts[subdistricts["amphure_id"] == district_id]
        subdistrict_names = subdistrict_data["name_th"].tolist()
        zip_codes = subdistrict_data["zip_code"].tolist()
        subdistrict = st.selectbox("Subdistrict *", ["Select Subdistrict"] + subdistrict_names)

        # ‚úÖ ‡∏î‡∏∂‡∏á‡∏£‡∏´‡∏±‡∏™‡πÑ‡∏õ‡∏£‡∏©‡∏ì‡∏µ‡∏¢‡πå‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡∏à‡∏≤‡∏Å‡∏ï‡∏≥‡∏ö‡∏•
        if subdistrict != "Select Subdistrict":
            subdistrict_index = subdistrict_names.index(subdistrict)
            zip_code = zip_codes[subdistrict_index]
        else:
            zip_code = ""
    else:
        subdistrict = st.selectbox("Subdistrict *", ["Select Subdistrict"])
        zip_code = ""

    st.text_input("Zip Code *", zip_code, disabled=True)  # ‡∏£‡∏´‡∏±‡∏™‡πÑ‡∏õ‡∏£‡∏©‡∏ì‡∏µ‡∏¢‡πå‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏Ñ‡πà‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å

    st.markdown("#### Account Information")
    email = st.text_input("Email address *", placeholder="Enter your email")
    password = st.text_input("Password *", type="password", placeholder="Enter your password")

    # ‚úÖ ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏ó‡∏∏‡∏Å‡∏ä‡πà‡∏≠‡∏á‡∏Å‡∏£‡∏≠‡∏Å‡∏Ñ‡∏£‡∏ö‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
    required_fields = [first_name, last_name, national_id, str(dob), gender, nationality,
                       address, province, district, subdistrict, zip_code, email, password]

    all_fields_filled = all(bool(field) and field.strip() != "" for field in required_fields)

    if not all_fields_filled:
        st.warning("‚ö†Ô∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏∏‡∏Å‡∏ä‡πà‡∏≠‡∏á‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡∏Å‡∏î Submit")

    # ‚úÖ ‡∏õ‡∏∏‡πà‡∏° Submit (‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡∏Å‡∏£‡∏≠‡∏Å‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö)
    submit_button = st.form_submit_button("Submit", disabled=not all_fields_filled)

# ‚úÖ ‡∏ñ‡πâ‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ñ‡∏£‡∏ö‡πÅ‡∏•‡∏∞‡∏Å‡∏î Submit ‡πÉ‡∏´‡πâ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏á Google Sheets
if submit_button:
    try:
        sheet.append_row([first_name, last_name, national_id, str(dob), gender, nationality,
                          address, province, district, subdistrict, zip_code, email, password])
        st.success(f"üéâ Welcome, {first_name}! You have successfully registered.")
    except Exception as e:
        st.error(f"‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ: {e}")

# ‚úÖ ‡∏õ‡∏∏‡πà‡∏°‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô
st.page_link("app.py", label="‚¨ÖÔ∏è Back to Login", icon="üîô")
